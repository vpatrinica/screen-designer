<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Roof Sensor Map</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root { --toolbar-height: 76px; }
        
        body {
            font-family: Inter, sans-serif;
            background: #f8fafc;
            overflow-x: hidden;
        }
        
        .app-container {
            position: relative;
            height: 100vh;
            overflow: hidden;
            padding-bottom: var(--toolbar-height); /* keep content clear of sticky toolbar */
        }
        
        .screens-container {
            display: flex;
            height: 100vh;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform;
        }
        
        .screen {
            min-width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding-bottom: var(--toolbar-height); /* ensure bottom content not covered */
        }
        
        .screen-header {
            padding: 1rem;
            background: white;
            border-bottom: 1px solid #e5e7eb;
            text-align: center;
            z-index: 10;
        }
        
        .screen-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
        }
        
        .map-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        .map-area {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
        }
        
        .sensor-panel {
            width: 300px;
            background: white;
            border-left: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
        }
        
        @media (max-width: 768px) {
            .map-container {
                flex-direction: column;
            }
            
            .sensor-panel {
                width: 100%;
                max-height: 40vh;
                border-left: none;
                border-top: 1px solid #e5e7eb;
            }
        }
        
        .panel-header {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .panel-title {
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
            text-align: center;
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.375rem 0.75rem;
            border: 2px solid transparent;
            border-radius: 0.375rem;
            background: #f9fafb;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        
        .legend-item.active {
            border-color: #3b82f6;
            background: #dbeafe;
        }
        
        .sensor-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
            padding-bottom: calc(var(--toolbar-height) + 12px); /* allow list to scroll above toolbar on mobile */
        }
        
        .sensor-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .sensor-list-item:hover,
        .sensor-list-item.highlight {
            background: #ebf8ff;
        }
        
        .sensor-list-item .name {
            font-weight: 600;
            font-size: 0.875rem;
        }
        
        .sensor-list-item .value {
            font-size: 0.75rem;
            color: #6b7280;
        }
        
        .sensor-list-item .value.alert {
            color: #ef4444;
            font-weight: 600;
        }
        
        .toolbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 2px solid #e5e7eb;
            height: var(--toolbar-height);
            padding: 0 1rem;
            z-index: 50;
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
        }
        
        .toolbar-nav {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            flex-wrap: nowrap;
            width: 100%;
            align-items: center;
        }
        
        .nav-label { color: #6b7280; font-size: 0.875rem; margin: 0 0.25rem 0 0.5rem; white-space: nowrap; }
        
        .nav-btn {
            padding: 0.4rem 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            background: white;
            color: #374151;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }
        
        .nav-btn.active {
            border-color: #3b82f6;
            background: #3b82f6;
            color: white;
        }
        
        .nav-btn:hover:not(.active) {
            border-color: #9ca3af;
            background: #f9fafb;
        }
        
        .rocket-btn {
            position: fixed;
            bottom: 100px;
            right: 1rem;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #3b82f6;
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            transition: all 0.3s;
            z-index: 40;
            transform: translateY(0);
            opacity: 1;
        }
        
        .rocket-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.5);
        }
        
        .map-svg {
            width: 100%;
            height: 100%;
            max-height: calc(100vh - 160px);
        }
        
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            pointer-events: none;
            z-index: 30;
            opacity: 0;
            transition: opacity 0.2s;
            max-width: 200px;
        }
        
        .tooltip.visible {
            opacity: 1;
        }
        
        .tooltip .title {
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        
        /* SVG specific styles */
        .sensor-group {
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        .sensor-group:hover {
            filter: brightness(1.1);
        }
        
        .alert-glow .sensor-point-group {
            filter: url(#glow);
        }
        
        .region-label {
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .region-label:hover {
            fill: #3b82f6;
            transform: scale(1.05);
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        .alert-glow {
            animation: pulse 2s infinite;
        }

        /* Small action buttons in panel header */
        .actions { display: flex; flex-wrap: wrap; gap: 0.375rem; justify-content: center; margin-top: 0.5rem; }
        .action-btn { padding: 0.375rem 0.625rem; font-size: 0.8rem; border: 1px solid #e5e7eb; border-radius: 0.375rem; background: #f9fafb; cursor: pointer; }
        .action-btn:hover { background: #eef2f7; }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="screens-container" id="screensContainer">
            <!-- Full View Screen -->
            <div class="screen" id="screen-full">
                <div class="screen-header">
                    <h1>Interactive Roof Sensor Map - Gesamt√ºbersicht</h1>
                </div>
                <div class="map-container">
                    <div class="map-area">
                        <svg class="map-svg" viewBox="100 0 700 650" id="fullMapSvg">
                            <defs>
                                <filter id="glow" x="-100%" y="-100%" width="300%" height="300%">
                                    <feGaussianBlur stdDeviation="10" result="coloredBlur"/>
                                    <feMerge>
                                        <feMergeNode in="coloredBlur"/>
                                        <feMergeNode in="SourceGraphic"/>
                                    </feMerge>
                                </filter>
                            </defs>
                            <!-- Region Labels -->
                            <g id="region-labels" opacity="0.4" font-family="Inter, sans-serif" font-size="4rem" font-weight="bold" fill="#d9534f" text-anchor="middle">
                                <text x="525" y="190" class="region-label" data-region="1">1</text>
                                <text x="525" y="520" class="region-label" data-region="2">2</text>
                                <text x="245" y="190" class="region-label" data-region="3">3</text>
                                <text x="245" y="520" class="region-label" data-region="4">4</text>
                            </g>
                            <!-- Sensors will be inserted here -->
                        </svg>
                    </div>
                    <div class="sensor-panel">
                        <div class="panel-header">
                            <h2 class="panel-title" id="sensorListTitle">Alle Sensoren</h2>
                            <div class="legend" id="legendContainer" style="flex-direction:column; gap:0.25rem;">
                                <div style="display:flex; gap:0.5rem; justify-content:center;">
                                    <div class="legend-item active" data-type="all">
                                        <span>Alle</span>
                                    </div>
                                    <div class="legend-item" data-type="flow">
                                        <svg width="16" height="16" viewBox="0 0 16 16">
                                            <circle cx="8" cy="8" r="7" fill="#2dd4bf" stroke="#1a202c" stroke-width="1"/>
                                        </svg>
                                        <span>Durchfluss</span>
                                    </div>
                                </div>
                                <div style="display:flex; gap:0.5rem; justify-content:center;">
                                    <div class="legend-item" data-type="pressure">
                                        <svg width="16" height="16" viewBox="0 0 16 16">
                                            <path d="M 8 8 L 0 8 A 8 8 0 0 1 8 0 Z" fill="#10b981"/>
                                            <path d="M 8 8 L 8 0 A 8 8 0 0 1 16 8 Z" fill="#ef4444"/>
                                            <path d="M 8 8 L 16 8 A 8 8 0 0 1 8 16 Z" fill="#10b981"/>
                                            <path d="M 8 8 L 8 16 A 8 8 0 0 1 0 8 Z" fill="#ef4444"/>
                                            <circle cx="8" cy="8" r="8" fill="none" stroke="#1a202c" stroke-width="1"/>
                                        </svg>
                                        <span>Druck</span>
                                    </div>
                                    <div class="legend-item" data-type="snow">
                                        <svg width="16" height="16" viewBox="0 0 16 16">
                                            <circle cx="8" cy="8" r="7" fill="black" stroke="white" stroke-width="1"/>
                                            <circle cx="8" cy="8" r="1" fill="white"/>
                                        </svg>
                                        <span>Schnee</span>
                                    </div>
                                </div>
                            </div>
                            <div class="actions">
                                <button class="action-btn" data-action="save-config">Save Config</button>
                                <button class="action-btn" data-action="load-config">Load Config</button>
                                <button class="action-btn" data-action="export-svg">Save SVG Map</button>
                                <button class="action-btn" data-action="export-standalone">Save Standalone SVG</button>
                            </div>
                        </div>
                        <div class="sensor-list" id="sensorList" style="min-height:calc(5 * 2.5rem);"></div>
                    </div>
                </div>
            </div>

            <!-- Region Screens -->
            <div class="screen" id="screen-1">
                <div class="screen-header">
                    <h1>Region 1 - Sensor Map</h1>
                </div>
                <div class="map-container">
                    <div class="map-area">
                        <svg class="map-svg" viewBox="400 20 400 400" id="region1MapSvg">
                            <use href="#sensorDefs"/>
                        </svg>
                    </div>
                    <div class="sensor-panel">
                        <div class="panel-header">
                            <h2 class="panel-title" id="region1Title">Alle Sensoren</h2>
                            <div class="legend" id="region1Legend" style="flex-direction:column; gap:0.25rem;">
                                <div style="display:flex; gap:0.5rem; justify-content:center;">
                                    <div class="legend-item active" data-type="all">
                                        <span>Alle</span>
                                    </div>
                                    <div class="legend-item" data-type="flow">
                                        <svg width="16" height="16" viewBox="0 0 16 16">
                                            <circle cx="8" cy="8" r="7" fill="#2dd4bf" stroke="#1a202c" stroke-width="1"/>
                                        </svg>
                                        <span>Durchfluss</span>
                                    </div>
                                </div>
                                <div style="display:flex; gap:0.5rem; justify-content:center;">
                                    <div class="legend-item" data-type="pressure">
                                        <svg width="16" height="16" viewBox="0 0 16 16">
                                            <path d="M 8 8 L 0 8 A 8 8 0 0 1 8 0 Z" fill="#10b981"/>
                                            <path d="M 8 8 L 8 0 A 8 8 0 0 1 16 8 Z" fill="#ef4444"/>
                                            <path d="M 8 8 L 16 8 A 8 8 0 0 1 8 16 Z" fill="#10b981"/>
                                            <path d="M 8 8 L 8 16 A 8 8 0 0 1 0 8 Z" fill="#ef4444"/>
                                            <circle cx="8" cy="8" r="8" fill="none" stroke="#1a202c" stroke-width="1"/>
                                        </svg>
                                        <span>Druck</span>
                                    </div>
                                    <div class="legend-item" data-type="snow">
                                        <svg width="16" height="16" viewBox="0 0 16 16">
                                            <circle cx="8" cy="8" r="7" fill="black" stroke="white" stroke-width="1"/>
                                            <circle cx="8" cy="8" r="1" fill="white"/>
                                        </svg>
                                        <span>Schnee</span>
                                    </div>
                                </div>
                            </div>
                            <div class="actions">
                                <button class="action-btn" data-action="save-config">Save Config</button>
                                <button class="action-btn" data-action="load-config">Load Config</button>
                                <button class="action-btn" data-action="export-svg">Save SVG Map</button>
                                <button class="action-btn" data-action="export-standalone">Save Standalone SVG</button>
                            </div>
                        </div>
                        <div class="sensor-list" id="region1List" style="min-height:calc(5 * 2.5rem);"></div>
                    </div>
                </div>
            </div>

            <div class="screen" id="screen-2">
                <div class="screen-header">
                    <h1>Region 2 - Sensor Map</h1>
                </div>
                <div class="map-container">
                    <div class="map-area">
                        <svg class="map-svg" viewBox="400 340 400 300" id="region2MapSvg">
                            <use href="#sensorDefs"/>
                        </svg>
                    </div>
                    <div class="sensor-panel">
                        <div class="panel-header">
                            <h2 class="panel-title" id="region2Title">Alle Sensoren</h2>
                            <div class="legend" id="region2Legend" style="flex-direction:column; gap:0.25rem;">
                                <div style="display:flex; gap:0.5rem; justify-content:center;">
                                    <div class="legend-item active" data-type="all">
                                        <span>Alle</span>
                                    </div>
                                    <div class="legend-item" data-type="flow">
                                        <svg width="16" height="16" viewBox="0 0 16 16">
                                            <circle cx="8" cy="8" r="7" fill="#2dd4bf" stroke="#1a202c" stroke-width="1"/>
                                        </svg>
                                        <span>Durchfluss</span>
                                    </div>
                                </div>
                                <div style="display:flex; gap:0.5rem; justify-content:center;">
                                    <div class="legend-item" data-type="pressure">
                                        <svg width="16" height="16" viewBox="0 0 16 16">
                                            <path d="M 8 8 L 0 8 A 8 8 0 0 1 8 0 Z" fill="#10b981"/>
                                            <path d="M 8 8 L 8 0 A 8 8 0 0 1 16 8 Z" fill="#ef4444"/>
                                            <path d="M 8 8 L 16 8 A 8 8 0 0 1 8 16 Z" fill="#10b981"/>
                                            <path d="M 8 8 L 8 16 A 8 8 0 0 1 0 8 Z" fill="#ef4444"/>
                                            <circle cx="8" cy="8" r="8" fill="none" stroke="#1a202c" stroke-width="1"/>
                                        </svg>
                                        <span>Druck</span>
                                    </div>
                                    <div class="legend-item" data-type="snow">
                                        <svg width="16" height="16" viewBox="0 0 16 16">
                                            <circle cx="8" cy="8" r="7" fill="black" stroke="white" stroke-width="1"/>
                                            <circle cx="8" cy="8" r="1" fill="white"/>
                                        </svg>
                                        <span>Schnee</span>
                                    </div>
                                </div>
                            </div>
                            <div class="actions">
                                <button class="action-btn" data-action="save-config">Save Config</button>
                                <button class="action-btn" data-action="load-config">Load Config</button>
                                <button class="action-btn" data-action="export-svg">Save SVG Map</button>
                                <button class="action-btn" data-action="export-standalone">Save Standalone SVG</button>
                            </div>
                        </div>
                        <div class="sensor-list" id="region2List" style="min-height:calc(5 * 2.5rem);"></div>
                    </div>
                </div>
            </div>

            <div class="screen" id="screen-3">
                <div class="screen-header">
                    <h1>Region 3 - Sensor Map</h1>
                </div>
                <div class="map-container">
                    <div class="map-area">
                        <svg class="map-svg" viewBox="100 20 400 400" id="region3MapSvg">
                            <use href="#sensorDefs"/>
                        </svg>
                    </div>
                    <div class="sensor-panel">
                        <div class="panel-header">
                            <h2 class="panel-title" id="region3Title">Alle Sensoren</h2>
                            <div class="legend" id="region3Legend" style="flex-direction:column; gap:0.25rem;">
                                <div style="display:flex; gap:0.5rem; justify-content:center;">
                                    <div class="legend-item active" data-type="all">
                                        <span>Alle</span>
                                    </div>
                                    <div class="legend-item" data-type="flow">
                                        <svg width="16" height="16" viewBox="0 0 16 16">
                                            <circle cx="8" cy="8" r="7" fill="#2dd4bf" stroke="#1a202c" stroke-width="1"/>
                                        </svg>
                                        <span>Durchfluss</span>
                                    </div>
                                </div>
                                <div style="display:flex; gap:0.5rem; justify-content:center;">
                                    <div class="legend-item" data-type="pressure">
                                        <svg width="16" height="16" viewBox="0 0 16 16">
                                            <path d="M 8 8 L 0 8 A 8 8 0 0 1 8 0 Z" fill="#10b981"/>
                                            <path d="M 8 8 L 8 0 A 8 8 0 0 1 16 8 Z" fill="#ef4444"/>
                                            <path d="M 8 8 L 16 8 A 8 8 0 0 1 8 16 Z" fill="#10b981"/>
                                            <path d="M 8 8 L 8 16 A 8 8 0 0 1 0 8 Z" fill="#ef4444"/>
                                            <circle cx="8" cy="8" r="8" fill="none" stroke="#1a202c" stroke-width="1"/>
                                        </svg>
                                        <span>Druck</span>
                                    </div>
                                    <div class="legend-item" data-type="snow">
                                        <svg width="16" height="16" viewBox="0 0 16 16">
                                            <circle cx="8" cy="8" r="7" fill="black" stroke="white" stroke-width="1"/>
                                            <circle cx="8" cy="8" r="1" fill="white"/>
                                        </svg>
                                        <span>Schnee</span>
                                    </div>
                                </div>
                            </div>
                            <div class="actions">
                                <button class="action-btn" data-action="save-config">Save Config</button>
                                <button class="action-btn" data-action="load-config">Load Config</button>
                                <button class="action-btn" data-action="export-svg">Save SVG Map</button>
                                <button class="action-btn" data-action="export-standalone">Save Standalone SVG</button>
                            </div>
                        </div>
                        <div class="sensor-list" id="region3List" style="min-height:calc(5 * 2.5rem);"></div>
                    </div>
                </div>
            </div>

            <div class="screen" id="screen-4">
                <div class="screen-header">
                    <h1>Region 4 - Sensor Map</h1>
                </div>
                <div class="map-container">
                    <div class="map-area">
                        <svg class="map-svg" viewBox="100 340 400 300" id="region4MapSvg">
                            <use href="#sensorDefs"/>
                        </svg>
                    </div>
                    <div class="sensor-panel">
                        <div class="panel-header">
                            <h2 class="panel-title" id="region4Title">Alle Sensoren</h2>
                            <div class="legend" id="region4Legend" style="flex-direction:column; gap:0.25rem;">
                                <div style="display:flex; gap:0.5rem; justify-content:center;">
                                    <div class="legend-item active" data-type="all">
                                        <span>Alle</span>
                                    </div>
                                    <div class="legend-item" data-type="flow">
                                        <svg width="16" height="16" viewBox="0 0 16 16">
                                            <circle cx="8" cy="8" r="7" fill="#2dd4bf" stroke="#1a202c" stroke-width="1"/>
                                        </svg>
                                        <span>Durchfluss</span>
                                    </div>
                                </div>
                                <div style="display:flex; gap:0.5rem; justify-content:center;">
                                    <div class="legend-item" data-type="pressure">
                                        <svg width="16" height="16" viewBox="0 0 16 16">
                                            <path d="M 8 8 L 0 8 A 8 8 0 0 1 8 0 Z" fill="#10b981"/>
                                            <path d="M 8 8 L 8 0 A 8 8 0 0 1 16 8 Z" fill="#ef4444"/>
                                            <path d="M 8 8 L 16 8 A 8 8 0 0 1 8 16 Z" fill="#10b981"/>
                                            <path d="M 8 8 L 8 16 A 8 8 0 0 1 0 8 Z" fill="#ef4444"/>
                                            <circle cx="8" cy="8" r="8" fill="none" stroke="#1a202c" stroke-width="1"/>
                                        </svg>
                                        <span>Druck</span>
                                    </div>
                                    <div class="legend-item" data-type="snow">
                                        <svg width="16" height="16" viewBox="0 0 16 16">
                                            <circle cx="8" cy="8" r="7" fill="black" stroke="white" stroke-width="1"/>
                                            <circle cx="8" cy="8" r="1" fill="white"/>
                                        </svg>
                                        <span>Schnee</span>
                                    </div>
                                </div>
                            </div>
                            <div class="actions">
                                <button class="action-btn" data-action="save-config">Save Config</button>
                                <button class="action-btn" data-action="load-config">Load Config</button>
                                <button class="action-btn" data-action="export-svg">Save SVG Map</button>
                                <button class="action-btn" data-action="export-standalone">Save Standalone SVG</button>
                            </div>
                        </div>
                        <div class="sensor-list" id="region4List" style="min-height:calc(5 * 2.5rem);"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rocket Button -->
        <button class="rocket-btn visible" id="rocketBtn">üöÄ</button>

        <!-- Bottom Toolbar -->
        <div class="toolbar">
            <div class="toolbar-nav">
                <button class="nav-btn active" data-screen="full">Gesamt√ºbersicht</button>
                <span class="nav-label">Regionen:</span>
                <button class="nav-btn" data-screen="1">1</button>
                <button class="nav-btn" data-screen="2">2</button>
                <button class="nav-btn" data-screen="3">3</button>
                <button class="nav-btn" data-screen="4">4</button>
            </div>
        </div>

        <!-- Tooltip -->
        <div class="tooltip" id="tooltip">
            <div class="title" id="tooltipTitle"></div>
            <div id="tooltipContent"></div>
        </div>
    </div>

    <!-- Hidden file input for Load Config -->
    <input type="file" id="fileInput" accept="application/json" style="display:none" />

    <!-- Hidden SVG definitions -->
    <svg style="display: none;">
        <defs id="sensorDefs">
            <filter id="glow" x="-100%" y="-100%" width="300%" height="300%">
                <feGaussianBlur stdDeviation="10" result="coloredBlur"/>
                <feMerge>
                    <feMergeNode in="coloredBlur"/>
                    <feMergeNode in="SourceGraphic"/>
                </feMerge>
            </filter>
        </defs>
    </svg>

    <script>
    // Sensor data
    const sensorData = [
  {
    "id": "f1",
    "displayId": "1",
    "type": "flow",
    "x": 524,
    "y": 52,
    "region": 1,
    "data": {
      "Flow": "1.2 m/s"
    }
  },
  {
    "id": "f2",
    "displayId": "2",
    "type": "flow",
    "x": 561,
    "y": 87,
    "region": 1,
    "data": {
      "Flow": "1.1 m/s"
    }
  },
  {
    "id": "f3",
    "displayId": "3",
    "type": "flow",
    "x": 589,
    "y": 125,
    "region": 1,
    "data": {
      "Flow": "1.3 m/s"
    }
  },
  {
    "id": "f4",
    "displayId": "4",
    "type": "flow",
    "x": 615,
    "y": 170,
    "region": 1,
    "data": {
      "Flow": "1.2 m/s"
    }
  },
  {
    "id": "f5",
    "displayId": "5",
    "type": "flow",
    "x": 642,
    "y": 217,
    "region": 1,
    "data": {
      "Flow": "1.4 m/s"
    }
  },
  {
    "id": "f6",
    "displayId": "6",
    "type": "flow",
    "x": 670,
    "y": 260,
    "region": 1,
    "data": {
      "Flow": "1.1 m/s"
    }
  },
  {
    "id": "f7",
    "displayId": "7",
    "type": "flow",
    "x": 691,
    "y": 316,
    "region": 1,
    "data": {
      "Flow": "1.0 m/s"
    }
  },
  {
    "id": "f8",
    "displayId": "8",
    "type": "flow",
    "x": 565,
    "y": 332,
    "region": 2,
    "data": {
      "Flow": "1.2 m/s"
    }
  },
  {
    "id": "f9",
    "displayId": "9",
    "type": "flow",
    "x": 710,
    "y": 380,
    "region": 2,
    "data": {
      "Flow": "1.3 m/s"
    }
  },
  {
    "id": "f10",
    "displayId": "10",
    "type": "flow",
    "x": 565,
    "y": 381,
    "region": 2,
    "data": {
      "Flow": "1.1 m/s"
    }
  },
  {
    "id": "f11",
    "displayId": "11",
    "type": "flow",
    "x": 727,
    "y": 423,
    "region": 2,
    "data": {
      "Flow": "1.2 m/s"
    }
  },
  {
    "id": "f12",
    "displayId": "12",
    "type": "flow",
    "x": 564,
    "y": 422,
    "region": 2,
    "data": {
      "Flow": "1.0 m/s"
    }
  },
  {
    "id": "f13",
    "displayId": "13",
    "type": "flow",
    "x": 748,
    "y": 463,
    "region": 2,
    "data": {
      "Flow": "1.1 m/s"
    }
  },
  {
    "id": "f14",
    "displayId": "14",
    "type": "flow",
    "x": 564,
    "y": 469,
    "region": 2,
    "data": {
      "Flow": "1.3 m/s"
    }
  },
  {
    "id": "f15",
    "displayId": "15",
    "type": "flow",
    "x": 760,
    "y": 511,
    "region": 2,
    "data": {
      "Flow": "1.2 m/s"
    }
  },
  {
    "id": "f16",
    "displayId": "16",
    "type": "flow",
    "x": 562,
    "y": 516,
    "region": 2,
    "data": {
      "Flow": "1.4 m/s"
    }
  },
  {
    "id": "f17",
    "displayId": "17",
    "type": "flow",
    "x": 767,
    "y": 560,
    "region": 2,
    "data": {
      "Flow": "1.1 m/s"
    }
  },
  {
    "id": "f18",
    "displayId": "18",
    "type": "flow",
    "x": 563,
    "y": 561,
    "region": 2,
    "data": {
      "Flow": "1.0 m/s"
    }
  },
  {
    "id": "f19",
    "displayId": "19",
    "type": "flow",
    "x": 377,
    "y": 47,
    "region": 3,
    "data": {
      "Flow": "1.2 m/s"
    }
  },
  {
    "id": "f20",
    "displayId": "20",
    "type": "flow",
    "x": 338,
    "y": 80,
    "region": 3,
    "data": {
      "Flow": "1.1 m/s"
    }
  },
  {
    "id": "f21",
    "displayId": "21",
    "type": "flow",
    "x": 306,
    "y": 123,
    "region": 3,
    "data": {
      "Flow": "1.2 m/s"
    }
  },
  {
    "id": "f22",
    "displayId": "22",
    "type": "flow",
    "x": 277,
    "y": 159,
    "region": 3,
    "data": {
      "Flow": "1.4 m/s"
    }
  },
  {
    "id": "f23",
    "displayId": "23",
    "type": "flow",
    "x": 246,
    "y": 207,
    "region": 3,
    "data": {
      "Flow": "1.1 m/s"
    }
  },
  {
    "id": "f24",
    "displayId": "24",
    "type": "flow",
    "x": 211,
    "y": 256,
    "region": 3,
    "data": {
      "Flow": "1.0 m/s"
    }
  },
  {
    "id": "f25",
    "displayId": "25",
    "type": "flow",
    "x": 183,
    "y": 312,
    "region": 3,
    "data": {
      "Flow": "1.3 m/s"
    }
  },
  {
    "id": "f26",
    "displayId": "26",
    "type": "flow",
    "x": 282,
    "y": 321,
    "region": 3,
    "data": {
      "Flow": "1.2 m/s"
    }
  },
  {
    "id": "f27",
    "displayId": "27",
    "type": "flow",
    "x": 164,
    "y": 367,
    "region": 4,
    "data": {
      "Flow": "1.2 m/s"
    }
  },
  {
    "id": "f28",
    "displayId": "28",
    "type": "flow",
    "x": 281,
    "y": 366,
    "region": 4,
    "data": {
      "Flow": "1.1 m/s"
    }
  },
  {
    "id": "f29",
    "displayId": "29",
    "type": "flow",
    "x": 146,
    "y": 410,
    "region": 4,
    "data": {
      "Flow": "1.1 m/s"
    }
  },
  {
    "id": "f30",
    "displayId": "30",
    "type": "flow",
    "x": 280,
    "y": 411,
    "region": 4,
    "data": {
      "Flow": "1.0 m/s"
    }
  },
  {
    "id": "f31",
    "displayId": "31",
    "type": "flow",
    "x": 130,
    "y": 456,
    "region": 4,
    "data": {
      "Flow": "1.2 m/s"
    }
  },
  {
    "id": "f32",
    "displayId": "32",
    "type": "flow",
    "x": 280,
    "y": 460,
    "region": 4,
    "data": {
      "Flow": "1.3 m/s"
    }
  },
  {
    "id": "f33",
    "displayId": "33",
    "type": "flow",
    "x": 115,
    "y": 504,
    "region": 4,
    "data": {
      "Flow": "1.1 m/s"
    }
  },
  {
    "id": "f34",
    "displayId": "34",
    "type": "flow",
    "x": 280,
    "y": 514,
    "region": 4,
    "data": {
      "Flow": "1.4 m/s"
    }
  },
  {
    "id": "f35",
    "displayId": "35",
    "type": "flow",
    "x": 113,
    "y": 550,
    "region": 4,
    "data": {
      "Flow": "1.0 m/s"
    }
  },
  {
    "id": "f36",
    "displayId": "36",
    "type": "flow",
    "x": 277,
    "y": 561,
    "region": 4,
    "data": {
      "Flow": "1.0 m/s"
    }
  },
  {
    "id": "p1",
    "displayId": "1",
    "type": "pressure",
    "x": 489,
    "y": 17,
    "region": 1,
    "status": "red",
    "data": {
      "Pressure": "1030 Pa"
    }
  },
  {
    "id": "p2",
    "displayId": "2",
    "type": "pressure",
    "x": 482,
    "y": 370,
    "region": 2,
    "status": "red",
    "data": {
      "Pressure": "1028 Pa"
    }
  },
  {
    "id": "p3",
    "displayId": "3",
    "type": "pressure",
    "x": 480,
    "y": 421,
    "region": 2,
    "status": "red",
    "data": {
      "Pressure": "1028 Pa"
    }
  },
  {
    "id": "p4",
    "displayId": "4",
    "type": "pressure",
    "x": 505,
    "y": 580,
    "region": 2,
    "status": "red",
    "data": {
      "Pressure": "980 Pa"
    }
  },
  {
    "id": "p5",
    "displayId": "5",
    "type": "pressure",
    "x": 441,
    "y": 583,
    "region": 2,
    "status": "red",
    "data": {
      "Pressure": "982 Pa"
    }
  },
  {
    "id": "p6",
    "displayId": "6",
    "type": "pressure",
    "x": 408,
    "y": 582,
    "region": 4,
    "status": "red",
    "data": {
      "Pressure": "979 Pa"
    }
  },
  {
    "id": "p7",
    "displayId": "7",
    "type": "pressure",
    "x": 323,
    "y": 580,
    "region": 4,
    "status": "red",
    "data": {
      "Pressure": "981 Pa"
    }
  },
  {
    "id": "p8",
    "displayId": "8",
    "type": "pressure",
    "x": 367,
    "y": 387,
    "region": 4,
    "status": "green",
    "data": {
      "Pressure": "1012 Pa"
    }
  },
  {
    "id": "p9",
    "displayId": "9",
    "type": "pressure",
    "x": 440,
    "y": 232,
    "region": 3,
    "status": "green",
    "data": {
      "Pressure": "1010 Pa"
    }
  },
  {
    "id": "p10",
    "displayId": "10",
    "type": "pressure",
    "x": 419,
    "y": 15,
    "region": 3,
    "status": "green",
    "data": {
      "Pressure": "1008 Pa"
    }
  },
  {
    "id": "s1",
    "displayId": "1",
    "type": "snow",
    "x": 632,
    "y": 82,
    "region": 1,
    "data": {
      "Snow Load": "5 kg/m¬≤"
    }
  },
  {
    "id": "s2",
    "displayId": "2",
    "type": "snow",
    "x": 544,
    "y": 592,
    "region": 2,
    "data": {
      "Snow Load": "4 kg/m¬≤"
    }
  },
  {
    "id": "s3",
    "displayId": "3",
    "type": "snow",
    "x": 187,
    "y": 591,
    "region": 4,
    "data": {
      "Snow Load": "6 kg/m¬≤"
    }
  }
];

        const VIEWBOXES = {
            full: '100 0 700 650',
            '1': '400 20 400 400',
            '2': '400 340 400 300',
            '3': '100 20 400 400',
            '4': '100 340 400 300'
        };

        const MAP_CONFIG = [
            { key: 'full', svgId: 'fullMapSvg', filter: () => true },
            { key: '1', svgId: 'region1MapSvg', filter: sensor => sensor.region === 1 },
            { key: '2', svgId: 'region2MapSvg', filter: sensor => sensor.region === 2 },
            { key: '3', svgId: 'region3MapSvg', filter: sensor => sensor.region === 3 },
            { key: '4', svgId: 'region4MapSvg', filter: sensor => sensor.region === 4 }
        ];

        const SENSOR_TYPE_BUILDERS = {
            pressure: sensor => {
                const { x, y } = sensor;
                const paths = [
                    { d: `M ${x} ${y} L ${x - 8} ${y} A 8 8 0 0 1 ${x} ${y - 8} Z`, fill: '#10b981' },
                    { d: `M ${x} ${y} L ${x} ${y - 8} A 8 8 0 0 1 ${x + 8} ${y} Z`, fill: '#ef4444' },
                    { d: `M ${x} ${y} L ${x + 8} ${y} A 8 8 0 0 1 ${x} ${y + 8} Z`, fill: '#10b981' },
                    { d: `M ${x} ${y} L ${x} ${y + 8} A 8 8 0 0 1 ${x - 8} ${y} Z`, fill: '#ef4444' }
                ];
                return [
                    ...paths.map(config => ({ tag: 'path', attrs: { d: config.d, fill: config.fill } })),
                    { tag: 'circle', attrs: { cx: x, cy: y, r: 8, fill: 'none', stroke: '#1a202c', 'stroke-width': 1 } }
                ];
            },
            flow: sensor => [{ tag: 'circle', attrs: { cx: sensor.x, cy: sensor.y, r: 8, fill: '#2dd4bf', stroke: '#1a202c', 'stroke-width': 1 } }],
            snow: sensor => [
                { tag: 'circle', attrs: { cx: sensor.x, cy: sensor.y, r: 8, fill: 'black', stroke: 'white', 'stroke-width': 1.5 } },
                { tag: 'circle', attrs: { cx: sensor.x, cy: sensor.y, r: 1.5, fill: 'white' } }
            ]
        };

        function buildSensorSpec(sensor) {
            const pointChildren = (SENSOR_TYPE_BUILDERS[sensor.type] || SENSOR_TYPE_BUILDERS.flow)(sensor);
            const classes = ['sensor-group'];
            if (sensor.status === 'red') {
                classes.push('alert-glow');
            }
            const displayId = String(sensor.displayId);

            return {
                tag: 'g',
                attrs: {
                    id: `sensor-group-${sensor.id}`,
                    'data-sensor-id': sensor.id
                },
                classList: classes,
                children: [
                    {
                        tag: 'g',
                        classList: ['sensor-point-group'],
                        children: pointChildren
                    },
                    {
                        tag: 'text',
                        attrs: {
                            x: sensor.x,
                            y: sensor.y,
                            'font-size': displayId.length > 1 ? 8 : 9,
                            fill: 'white',
                            'text-anchor': 'middle',
                            'dominant-baseline': 'central'
                        },
                        style: {
                            'pointer-events': 'none',
                            'font-weight': 'bold'
                        },
                        textContent: displayId
                    }
                ]
            };
        }

        function createSvgElementFromSpec(spec, doc) {
            const element = doc.createElementNS('http://www.w3.org/2000/svg', spec.tag);

            if (spec.attrs) {
                Object.entries(spec.attrs).forEach(([key, value]) => {
                    element.setAttribute(key, String(value));
                });
            }

            if (spec.classList) {
                spec.classList.filter(Boolean).forEach(cls => element.classList.add(cls));
            }

            if (spec.style) {
                Object.entries(spec.style).forEach(([prop, value]) => {
                    element.style.setProperty(prop, value);
                });
            }

            if (spec.textContent !== undefined) {
                element.textContent = spec.textContent;
            }

            if (spec.children) {
                spec.children.forEach(childSpec => {
                    element.appendChild(createSvgElementFromSpec(childSpec, doc));
                });
            }

            return element;
        }

        function escapeAttribute(value) {
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/"/g, '&quot;')
                .replace(/</g, '&lt;');
        }

        function escapeText(value) {
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;');
        }

        function specToString(spec) {
            const attributes = [];
            if (spec.attrs) {
                Object.entries(spec.attrs).forEach(([key, val]) => {
                    attributes.push(`${key}="${escapeAttribute(val)}"`);
                });
            }
            if (spec.classList && spec.classList.length) {
                attributes.push(`class="${escapeAttribute(spec.classList.filter(Boolean).join(' '))}"`);
            }
            if (spec.style && Object.keys(spec.style).length) {
                const styleValue = Object.entries(spec.style)
                    .map(([prop, val]) => `${prop}:${val}`)
                    .join(';');
                attributes.push(`style="${escapeAttribute(styleValue)}"`);
            }

            const openTag = attributes.length ? `<${spec.tag} ${attributes.join(' ')}>` : `<${spec.tag}>`;
            const children = spec.children ? spec.children.map(specToString).join('') : '';
            const text = spec.textContent !== undefined ? escapeText(spec.textContent) : '';

            return `${openTag}${text}${children}</${spec.tag}>`;
        }

        function buildSensorSVGShape(sensor) {
            return specToString(buildSensorSpec(sensor));
        }

        function renderAllSensorMaps() {
            MAP_CONFIG.forEach(({ svgId, filter }) => {
                const svg = document.getElementById(svgId);
                if (!svg) return;

                svg.querySelectorAll('.sensor-group').forEach(node => node.remove());

                const doc = svg.ownerDocument || document;
                sensorData.filter(filter).forEach(sensor => {
                    const spec = buildSensorSpec(sensor);
                    svg.appendChild(createSvgElementFromSpec(spec, doc));
                });
            });

            setupSensorGroupTooltips();
            ['full', '1', '2', '3', '4'].forEach(applyFilterToMap);
            hideTooltip();
            unhighlightSensor();
        }

        // App state
        let currentScreen = 'full';
        let currentFilters = {
            'full': 'all',
            '1': 'all',
            '2': 'all',
            '3': 'all',
            '4': 'all'
        };

        // DOM elements
        const screensContainer = document.getElementById('screensContainer');
        const rocketBtn = document.getElementById('rocketBtn');
        const tooltip = document.getElementById('tooltip');
        const tooltipTitle = document.getElementById('tooltipTitle');
        const tooltipContent = document.getElementById('tooltipContent');

        // Initialize the app
        function init() {
            renderAllSensorMaps();
            setupEventListeners();
            updateSensorList('full');
            updateNavigation();
            updateRocketButton();
        }

        // Navigation functions
        function navigateToScreen(screenId) {
            if (currentScreen === screenId) return;
            
            currentScreen = screenId;
            const screenIndex = ['full', '1', '2', '3', '4'].indexOf(screenId);
            const translateX = -screenIndex * 100;
            
            screensContainer.style.transform = `translateX(${translateX}vw)`;
            updateNavigation();
            updateSensorList(screenId);
            updateRocketButton();
        }

        function updateNavigation() {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.screen === currentScreen);
            });
        }

        function updateRocketButton() {
            rocketBtn.classList.add('visible');
        }

        // Sensor list functions
        function updateSensorList(screenId) {
            const isRegion = screenId !== 'full';
            const regionNumber = isRegion ? parseInt(screenId) : null;
            const filter = currentFilters[screenId];
            
            let filteredData = sensorData.slice();
            if (isRegion) {
                filteredData = sensorData.filter(s => s.region === regionNumber);
            }
            if (filter !== 'all') {
                filteredData = filteredData.filter(s => s.type === filter);
            }

            // Sort sensors
            filteredData.sort((a, b) => {
                if (a.type < b.type) return -1;
                if (a.type > b.type) return 1;
                const aId = parseInt(a.displayId);
                const bId = parseInt(b.displayId);
                if (!isNaN(aId) && !isNaN(bId)) return aId - bId;
                return a.displayId.localeCompare(b.displayId);
            });

            // Update title
            const titleElement = document.getElementById(screenId === 'full' ? 'sensorListTitle' : `region${screenId}Title`);
            let title = filter === 'all' ? 'All Sensors' : `${filter.charAt(0).toUpperCase() + filter.slice(1)} Sensors`;
            if (isRegion) title += ` (Region ${screenId})`;
            if (titleElement) titleElement.textContent = title;

            // Update list
            const listElement = document.getElementById(screenId === 'full' ? 'sensorList' : `region${screenId}List`);
            if (listElement) {
                listElement.innerHTML = filteredData.map(sensor => {
                    const value = sensor.data ? Object.values(sensor.data)[0] : '';
                    const isAlert = sensor.status === 'red';
                    const typeLabel = sensor.type.charAt(0).toUpperCase() + sensor.type.slice(1);
                    
                    return `
                        <div class="sensor-list-item" data-sensor-id="${sensor.id}">
                            <span class="name">${typeLabel} ${sensor.displayId}</span>
                            <span class="value ${isAlert ? 'alert' : ''}">${value}</span>
                        </div>
                    `;
                }).join('');

                // Add list interaction
                listElement.querySelectorAll('.sensor-list-item').forEach(item => {
                    item.addEventListener('mouseenter', () => highlightSensor(item.dataset.sensorId));
                    item.addEventListener('mouseleave', () => unhighlightSensor());
                });
            }

            applyFilterToMap(screenId);
        }

        function highlightSensor(sensorId) {
            // Highlight list item
            document.querySelectorAll('.sensor-list-item').forEach(item => {
                item.classList.toggle('highlight', item.dataset.sensorId === sensorId);
            });

            // Highlight sensor on map
            document.querySelectorAll('.sensor-group').forEach(group => {
                group.style.opacity = group.dataset.sensorId === sensorId ? '1' : '0.3';
            });
        }

        function unhighlightSensor() {
            document.querySelectorAll('.sensor-list-item').forEach(item => {
                item.classList.remove('highlight');
            });
            document.querySelectorAll('.sensor-group').forEach(group => {
                group.style.opacity = '1';
            });
        }

        function applyFilterToMap(screenId) {
            const filter = currentFilters[screenId];
            if (!filter) return;

            const targetIds = screenId === 'full'
                ? ['fullMapSvg']
                : [`region${screenId}MapSvg`];

            targetIds.forEach(svgId => {
                const svg = document.getElementById(svgId);
                if (!svg) return;

                svg.querySelectorAll('.sensor-group').forEach(group => {
                    const sensor = sensorData.find(s => s.id === group.dataset.sensorId);
                    if (!sensor) return;
                    const matches = filter === 'all' || sensor.type === filter;
                    group.style.display = matches ? '' : 'none';
                });
            });
        }

        // Filter functions
        function setupLegendFilters() {
            ['full', '1', '2', '3', '4'].forEach(screenId => {
                const legendContainer = document.getElementById(screenId === 'full' ? 'legendContainer' : `region${screenId}Legend`);
                if (!legendContainer) return;
                legendContainer.querySelectorAll('.legend-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const filterType = item.dataset.type;
                        currentFilters[screenId] = filterType;
                        
                        // Update active state
                        legendContainer.querySelectorAll('.legend-item').forEach(legendItem => {
                            legendItem.classList.toggle('active', legendItem.dataset.type === filterType);
                        });
                        
                        updateSensorList(screenId);
                    });
                });
            });
        }

        // Tooltip functions
        function showTooltip(event, sensor) {
            const typeLabel = sensor.type.charAt(0).toUpperCase() + sensor.type.slice(1);
            tooltipTitle.textContent = `${typeLabel} Sensor #${sensor.displayId}`;
            const dataEntries = sensor.data ? Object.entries(sensor.data) : [];
            tooltipContent.innerHTML = dataEntries
                .map(([key, value]) => `<strong>${key}:</strong> ${value}`)
                .join('<br>');
            
            tooltip.style.left = `${event.clientX + 15}px`;
            tooltip.style.top = `${event.clientY + 15}px`;
            tooltip.classList.add('visible');
        }

        function hideTooltip() {
            tooltip.classList.remove('visible');
        }

        // Event listeners setup
        function setupEventListeners() {
            // Navigation buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    navigateToScreen(btn.dataset.screen);
                });
            });

            // Region labels (clickable)
            document.querySelectorAll('.region-label').forEach(label => {
                label.addEventListener('click', () => {
                    navigateToScreen(label.dataset.region);
                });
            });

            // Rocket button
            rocketBtn.addEventListener('click', () => {
                navigateToScreen('full');
            });

            // Legend filters
            setupLegendFilters();

            // Prevent scroll on mobile
            document.addEventListener('touchmove', (e) => {
                if (e.target.closest('.sensor-list')) return;
                e.preventDefault();
            }, { passive: false });

            // Hide tooltip on scroll
            document.addEventListener('scroll', hideTooltip);

            // Bind actions
            document.body.addEventListener('click', (e) => {
                const btn = e.target.closest('.action-btn');
                if (!btn) return;
                const action = btn.dataset.action;
                if (action === 'save-config') return saveConfig();
                if (action === 'export-svg') return saveSvgMap();
                if (action === 'export-standalone') return exportStandaloneSvg();
                if (action === 'load-config') {
                    document.getElementById('fileInput').click();
                }
            });
            document.getElementById('fileInput').addEventListener('change', (e) => {
                const file = e.target.files && e.target.files[0];
                if (file) loadConfigFromFile(file);
                e.target.value = '';
            });
        }

        // Download helper
        function triggerDownload(filename, content, mime = 'application/octet-stream') {
            const blob = new Blob([content], { type: mime });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 0);
        }

        // Save configuration
        function saveConfig() {
            const json = JSON.stringify(sensorData, null, 2);
            triggerDownload('sensor-config.json', json, 'application/json');
        }

        // Load configuration
        function loadConfigFromFile(file) {
            const reader = new FileReader();
            reader.onload = () => {
                try {
                    const parsed = JSON.parse(reader.result);
                    if (!Array.isArray(parsed)) throw new Error('Invalid format');
                    // Replace data
                    sensorData.length = 0;
                    parsed.forEach(o => sensorData.push(o));
                    renderAllSensorMaps();
                    updateSensorList(currentScreen);
                } catch (e) {
                    alert('Invalid configuration file.');
                }
            };
            reader.readAsText(file);
        }

        // Save SVG map
        function saveSvgMap() {
            const view = currentScreen;
            const vb = VIEWBOXES[view];
            let data = (view === 'full') ? sensorData.slice() : sensorData.filter(function(s){ return s.region === parseInt(view); });
            const filter = currentFilters[view];
            if (filter && filter !== 'all') data = data.filter(function(s){ return s.type === filter; });

            const sensorsMarkup = data.map(buildSensorSVGShape).join('\n');
            var regionLabels = '';
            if (view === 'full') {
                regionLabels = [
                    '<g id="region-labels" opacity="0.4" font-family="Inter, sans-serif" font-size="4rem" font-weight="bold" fill="#d9534f" text-anchor="middle">',
                    '  <text x="525" y="190">1</text>',
                    '  <text x="525" y="520">2</text>',
                    '  <text x="245" y="190">3</text>',
                    '  <text x="245" y="520">4</text>',
                    '</g>'
                ].join('\n');
            }

            var svg = [
                '<?xml version="1.0" encoding="UTF-8"?>',
                '<svg xmlns="http://www.w3.org/2000/svg" viewBox="'+vb+'" width="100%" height="100%">',
                '  <defs>',
                '    <filter id="glow" x="-100%" y="-100%" width="300%" height="300%">',
                '      <feGaussianBlur stdDeviation="10" result="coloredBlur"/>',
                '      <feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge>',
                '    </filter>',
                '    <style><![CDATA[',
                '      .alert-glow .sensor-point-group { filter: url(#glow); }',
                '      .sensor-group { cursor: pointer; }',
                '    ]]></style>',
                '  </defs>',
                regionLabels,
                sensorsMarkup,
                '</svg>'
            ].join('\n');
            triggerDownload('roof-map-'+view+'.svg', svg, 'image/svg+xml;charset=utf-8');
        }

        // Export standalone SVG with interactive legends and navigation
        function exportStandaloneSvg() {
            const data = sensorData.slice();
            const viewBoxes = VIEWBOXES;
            const sensorsMarkup = data.map(buildSensorSVGShape).join('\n');

            const panelHTML = [
                '<div xmlns="http://www.w3.org/1999/xhtml" class="panel-container">',
                '  <div class="panel-header">',
                '    <h2 id="standalone-sensor-list-title">Alle Sensoren</h2>',
                '    <div id="standalone-legend-container" class="legend" style="flex-direction:column; gap:0.25rem;">',
                '      <div style="display:flex; gap:0.5rem; justify-content:center;">',
                '        <div class="legend-item active" data-type="all"><span>Alle</span></div>',
                '        <div class="legend-item" data-type="flow">',
                '          <svg width="16" height="16" viewBox="0 0 16 16"><circle cx="8" cy="8" r="7" fill="#2dd4bf" stroke="#1a202c" stroke-width="1"/></svg>',
                '          <span>Durchfluss</span>',
                '        </div>',
                '      </div>',
                '      <div style="display:flex; gap:0.5rem; justify-content:center;">',
                '        <div class="legend-item" data-type="pressure">',
                '          <svg width="16" height="16" viewBox="0 0 16 16">',
                '            <path d="M 8 8 L 0 8 A 8 8 0 0 1 8 0 Z" fill="#10b981"/>',
                '            <path d="M 8 8 L 8 0 A 8 8 0 0 1 16 8 Z" fill="#ef4444"/>',
                '            <path d="M 8 8 L 16 8 A 8 8 0 0 1 8 16 Z" fill="#10b981"/>',
                '            <path d="M 8 8 L 8 16 A 8 8 0 0 1 0 8 Z" fill="#ef4444"/>',
                '            <circle cx="8" cy="8" r="8" fill="none" stroke="#1a202c" stroke-width="1"/>',
                '          </svg>',
                '          <span>Druck</span>',
                '        </div>',
                '        <div class="legend-item" data-type="snow">',
                '          <svg width="16" height="16" viewBox="0 0 16 16">',
                '            <circle cx="8" cy="8" r="7" fill="black" stroke="white" stroke-width="1"/>',
                '            <circle cx="8" cy="8" r="1" fill="white"/>',
                '          </svg>',
                '          <span>Schnee</span>',
                '        </div>',
                '      </div>',
                '    </div>',
                '  </div>',
                '  <div id="standalone-sensor-list" class="sensor-list" style="min-height:calc(5 * 2.5rem);"></div>',
                '</div>'
            ].join('\n');

            const toolbarHTML = [
                '<div xmlns="http://www.w3.org/1999/xhtml" class="bottom-toolbar">',
                '  <div id="bottom-toolbar-nav" class="toolbar-nav">',
                '    <button class="nav-btn" data-view="full">Gesamt√ºbersicht</button>',
                '    <span class="nav-label">Regionen:</span>',
                '    <button class="nav-btn" data-view="1">1</button>',
                '    <button class="nav-btn" data-view="2">2</button>',
                '    <button class="nav-btn" data-view="3">3</button>',
                '    <button class="nav-btn" data-view="4">4</button>',
                '  </div>',
                '</div>'
                        ].join('\n');

            const dataStr = JSON.stringify(data);
            const vbStr = JSON.stringify(viewBoxes);

            const svgParts = [];
            svgParts.push('<?xml version="1.0" encoding="UTF-8"?>');
            svgParts.push('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1100 650" width="100%" height="100%" id="main-svg">');
            svgParts.push('  <defs>');
            svgParts.push('    <filter id="glow" x="-100%" y="-100%" width="300%" height="300%">');
            svgParts.push('      <feGaussianBlur stdDeviation="10" result="coloredBlur"/>');
            svgParts.push('      <feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge>');
            svgParts.push('    </filter>');
            svgParts.push('    <style>');
            svgParts.push('      .alert-glow .sensor-point-group { filter: url(#glow); }');
            svgParts.push('      .sensor-group { cursor: pointer; }');
            svgParts.push('      .panel-container { font-family: sans-serif; background-color: #fff; border-radius: 8px; height: 100%; display:flex; flex-direction:column; }');
            svgParts.push('      .panel-header { padding:12px; border-bottom:1px solid #e5e7eb; }');
            svgParts.push('      .legend { display:flex; flex-direction:column; gap:4px; }');
            svgParts.push('      .legend-item { display:flex; align-items:center; gap:4px; padding:6px 10px; border-radius:6px; border:2px solid transparent; background:#f9fafb; cursor:pointer; }');
            svgParts.push('      .legend-item.active { border-color:#3b82f6; background:#dbeafe; }');
            svgParts.push('      .sensor-list { overflow:auto; padding:8px; }');
            svgParts.push('      .sensor-list-item { display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #f3f4f6; }');
            svgParts.push('      .sensor-list-item.highlight { background:#ebf8ff; }');
            svgParts.push('      .bottom-toolbar { height:72px; background:#fff; border-top:1px solid #e5e7eb; display:flex; align-items:center; justify-content:center; }');
            svgParts.push('      .nav-btn { cursor:pointer; padding:6px 10px; border-radius:6px; border:2px solid transparent; background:#f9fafb; }');
            svgParts.push('      .nav-btn.active { border-color:#3b82f6; background:#dbeafe; }');
            svgParts.push('    </style>');
            svgParts.push('  </defs>');

            svgParts.push('  <g id="mapLayer">');
            svgParts.push('    <g id="region-labels" opacity="0.4" font-family="Inter, sans-serif" font-size="4rem" font-weight="bold" fill="#d9534f" text-anchor="middle">');
            svgParts.push('      <text x="525" y="190" class="region-label" data-region="1" style="cursor:pointer" onclick="window.setView(\'1\')">1</text>');
            svgParts.push('      <text x="525" y="520" class="region-label" data-region="2" style="cursor:pointer" onclick="window.setView(\'2\')">2</text>');
            svgParts.push('      <text x="245" y="190" class="region-label" data-region="3" style="cursor:pointer" onclick="window.setView(\'3\')">3</text>');
            svgParts.push('      <text x="245" y="520" class="region-label" data-region="4" style="cursor:pointer" onclick="window.setView(\'4\')">4</text>');
            svgParts.push('    </g>');
            svgParts.push(sensorsMarkup);
            svgParts.push('  </g>');

            svgParts.push('  <foreignObject x="800" y="0" width="300" height="650">');
            svgParts.push(panelHTML);
            svgParts.push('  </foreignObject>');

            svgParts.push('  <foreignObject id="standalone-tooltip-fo" x="0" y="0" width="180" height="120" style="visibility:hidden; pointer-events:none">');
            svgParts.push('    <div xmlns="http://www.w3.org/1999/xhtml" id="standalone-tooltip-div" style="padding:0.75rem; background:rgba(0,0,0,0.85); color:white; border-radius:6px; font-size:14px"></div>');
            svgParts.push('  </foreignObject>');

            svgParts.push('  <foreignObject x="0" y="578" width="1100" height="72">');
            svgParts.push(toolbarHTML);
            svgParts.push('  </foreignObject>');

            const standaloneScript = String.raw`
(function(){
    const sensorData = ${dataStr};
    const viewBoxes = ${vbStr};
    let currentView = "full";
    let currentFilter = "all";

    const mapLayer = document.getElementById("mapLayer");
    const legend = document.getElementById("standalone-legend-container");
    const listContainer = document.getElementById("standalone-sensor-list");
    const titleEl = document.getElementById("standalone-sensor-list-title");
    const tooltipFO = document.getElementById("standalone-tooltip-fo");
    const tooltipDiv = document.getElementById("standalone-tooltip-div");
    const svgRoot = document.getElementById("main-svg");
    const bottomNav = document.getElementById("bottom-toolbar-nav");
    const mapViewport = { x: 0, y: 0, w: 800, h: 578 };

    function parseBox(value) {
        const parts = String(value || "").trim().split(/\s+/).map(Number);
        return { x: parts[0], y: parts[1], w: parts[2], h: parts[3] };
    }

    function setMapTransform(view) {
        const box = parseBox(viewBoxes[view]);
        const sx = mapViewport.w / box.w;
        const sy = mapViewport.h / box.h;
        const scale = Math.min(sx, sy);
        const tx = mapViewport.x - box.x * scale + (mapViewport.w - box.w * scale) / 2;
        const ty = mapViewport.y - box.y * scale + (mapViewport.h - box.h * scale) / 2;
        if (mapLayer) {
            mapLayer.setAttribute("transform", "translate(" + tx + "," + ty + ") scale(" + scale + ")");
        }
    }

    function sortSensors(items) {
        return items.slice().sort(function(a, b) {
            if (a.type < b.type) return -1;
            if (a.type > b.type) return 1;
            const ai = parseInt(a.displayId, 10);
            const bi = parseInt(b.displayId, 10);
            if (!isNaN(ai) && !isNaN(bi)) return ai - bi;
            return String(a.displayId).localeCompare(String(b.displayId));
        });
    }

    function highlightSensor(sensorId) {
        if (!sensorId) return;
        document.querySelectorAll(".sensor-group").forEach(function(group) {
            group.style.opacity = group.getAttribute("data-sensor-id") === sensorId ? "1" : "0.3";
        });
        if (listContainer) {
            listContainer.querySelectorAll(".sensor-list-item").forEach(function(item) {
                item.classList.toggle("highlight", item.getAttribute("data-sensor-id") === sensorId);
            });
        }
    }

    function clearHighlights() {
        document.querySelectorAll(".sensor-group").forEach(function(group) {
            group.style.opacity = "1";
        });
        if (listContainer) {
            listContainer.querySelectorAll(".sensor-list-item").forEach(function(item) {
                item.classList.remove("highlight");
            });
        }
    }

    function renderList() {
        if (!listContainer || !titleEl) return;
        const base = currentView === "full"
            ? sensorData.slice()
            : sensorData.filter(function(sensor) { return String(sensor.region) === String(currentView); });

        const filtered = currentFilter === "all"
            ? base
            : base.filter(function(sensor) { return sensor.type === currentFilter; });

        const sorted = sortSensors(filtered);
        const titleBase = currentFilter === "all"
            ? "Alle Sensoren"
            : currentFilter.charAt(0).toUpperCase() + currentFilter.slice(1) + " Sensoren";
        titleEl.textContent = currentView === "full"
            ? titleBase
            : titleBase + " (Region " + currentView + ")";

        listContainer.innerHTML = sorted.map(function(sensor) {
            const value = sensor.data ? Object.values(sensor.data)[0] : "";
            const typeLabel = sensor.type.charAt(0).toUpperCase() + sensor.type.slice(1);
            const isAlert = sensor.status === "red";
            return (
                '<div class="sensor-list-item" data-sensor-id="' + sensor.id + '">' +
                    '<span>' + typeLabel + ' ' + sensor.displayId + '</span>' +
                    '<span style="color:' + (isAlert ? '#ef4444' : '#4b5563') + '; font-weight:' + (isAlert ? '700' : '500') + '">' +
                        (value || '') +
                    '</span>' +
                '</div>'
            );
        }).join("");

        listContainer.querySelectorAll(".sensor-list-item").forEach(function(item) {
            item.addEventListener("mouseenter", function() {
                highlightSensor(item.getAttribute("data-sensor-id"));
            });
            item.addEventListener("mouseleave", function() {
                clearHighlights();
            });
        });
    }

    function showTooltip(evt, sensor) {
        if (!tooltipFO || !tooltipDiv || !svgRoot || !sensor) return;
        let content = '<div style="font-weight:700; margin-bottom:4px;">' +
            sensor.type.charAt(0).toUpperCase() + sensor.type.slice(1) + ' Sensor #' + sensor.displayId +
            '</div>';
        Object.entries(sensor.data || {}).forEach(function(entry) {
            content += '<div><strong>' + entry[0] + ':</strong> ' + entry[1] + '</div>';
        });
        tooltipDiv.innerHTML = content;
        tooltipFO.style.visibility = "visible";

        const point = svgRoot.createSVGPoint();
        point.x = evt.clientX;
        point.y = evt.clientY;
        const ctm = svgRoot.getScreenCTM();
        if (!ctm) return;
        const cursor = point.matrixTransform(ctm.inverse());
        tooltipFO.setAttribute("x", cursor.x + 15);
        tooltipFO.setAttribute("y", cursor.y + 15);
    }

    function hideTooltip() {
        if (tooltipFO) {
            tooltipFO.style.visibility = "hidden";
        }
    }

    function attachMapListeners() {
        document.querySelectorAll(".sensor-group").forEach(function(group) {
            const sensorId = group.getAttribute("data-sensor-id");
            const sensor = sensorData.find(function(item) { return item.id === sensorId; });
            group.addEventListener("mouseenter", function(evt) {
                highlightSensor(sensorId);
                showTooltip(evt, sensor);
            });
            group.addEventListener("mouseleave", function() {
                hideTooltip();
                clearHighlights();
            });
            group.addEventListener("mousemove", function(evt) {
                showTooltip(evt, sensor);
            });
        });
    }

    function syncNavButtons(view) {
        if (bottomNav) {
            bottomNav.querySelectorAll(".nav-btn").forEach(function(btn) {
                const matches = btn.getAttribute("data-view") === (view === "full" ? "full" : String(view));
                btn.classList.toggle("active", matches);
            });
        }
    }

    function setView(view) {
        currentView = view;
        setMapTransform(view);
        syncNavButtons(view);
        renderList();
    }

    function bindBottomNav() {
        if (!bottomNav) return;
        bottomNav.querySelectorAll(".nav-btn").forEach(function(btn) {
            btn.addEventListener("click", function() {
                setView(btn.getAttribute("data-view") || "full");
            });
        });
    }

    function bindLegend() {
        if (!legend) return;
        legend.querySelectorAll(".legend-item").forEach(function(item) {
            item.addEventListener("click", function() {
                currentFilter = item.getAttribute("data-type");
                legend.querySelectorAll(".legend-item").forEach(function(li) {
                    li.classList.toggle("active", li.getAttribute("data-type") === currentFilter);
                });
                renderList();
            });
        });
    }

    function bindRegionLabels() {
        document.querySelectorAll("#region-labels .region-label").forEach(function(label) {
            label.addEventListener("click", function() {
                const region = label.getAttribute("data-region");
                setView(region || "full");
            });
        });
    }

    bindLegend();
    bindBottomNav();
    bindRegionLabels();
    attachMapListeners();
    setView("full");
    window.setView = setView;
})();`;

                        const sanitizedScript = standaloneScript.replace(/\]\]>/g, ']]]]><![CDATA[>');
                        svgParts.push('  <script><![CDATA[' + sanitizedScript + ']]></script>');
                        svgParts.push('</svg>');

                        triggerDownload('roof-sensors-standalone.svg', svgParts.join('\n'), 'image/svg+xml;charset=utf-8');
                    }

                    // Attach tooltip listeners to sensor groups after first render
                    function setupSensorGroupTooltips() {
                        document.querySelectorAll('.sensor-group').forEach(group => {
                            const sensorId = group.dataset.sensorId;
                            const sensor = sensorData.find(s => s.id === sensorId);
                            if (!sensor) return;
                            group.addEventListener('mouseenter', (e) => {
                                highlightSensor(sensorId);
                                showTooltip(e, sensor);
                            });
                            group.addEventListener('mousemove', (e) => {
                                if (tooltip.classList.contains('visible')) {
                                    tooltip.style.left = `${e.clientX + 15}px`;
                                    tooltip.style.top = `${e.clientY + 15}px`;
                                }
                            });
                            group.addEventListener('mouseleave', () => {
                                hideTooltip();
                                unhighlightSensor();
                            });
                        });
                    }

                    // Initialize the application
                    init();
                </script>
            </body>
        </html>
        const ty = mapViewport.y - box.y * scale + (mapViewport.h - box.h * scale) / 2;
        if (mapLayer) {
            mapLayer.setAttribute("transform", "translate(" + tx + "," + ty + ") scale(" + scale + ")");
        }
    }

    function sortSensors(items) {
        return items.slice().sort(function(a, b) {
            if (a.type < b.type) return -1;
            if (a.type > b.type) return 1;
            const ai = parseInt(a.displayId, 10);
            const bi = parseInt(b.displayId, 10);
            if (!isNaN(ai) && !isNaN(bi)) return ai - bi;
            return String(a.displayId).localeCompare(String(b.displayId));
        });
    }

    function highlightSensor(sensorId) {
        if (!sensorId) return;
        document.querySelectorAll(".sensor-group").forEach(function(group) {
            group.style.opacity = group.getAttribute("data-sensor-id") === sensorId ? "1" : "0.3";
        });
        if (listContainer) {
            listContainer.querySelectorAll(".sensor-list-item").forEach(function(item) {
                item.classList.toggle("highlight", item.getAttribute("data-sensor-id") === sensorId);
            });
        }
    }

    function clearHighlights() {
        document.querySelectorAll(".sensor-group").forEach(function(group) {
            group.style.opacity = "1";
        });
        if (listContainer) {
            listContainer.querySelectorAll(".sensor-list-item").forEach(function(item) {
                item.classList.remove("highlight");
            });
        }
    }

    function renderList() {
        if (!listContainer || !titleEl) return;
        const base = currentView === "full"
            ? sensorData.slice()
            : sensorData.filter(function(sensor) { return String(sensor.region) === String(currentView); });

        const filtered = currentFilter === "all"
            ? base
            : base.filter(function(sensor) { return sensor.type === currentFilter; });

        const sorted = sortSensors(filtered);
        const titleBase = currentFilter === "all"
            ? "All Sensors"
            : currentFilter.charAt(0).toUpperCase() + currentFilter.slice(1) + " Sensors";
        titleEl.textContent = currentView === "full"
            ? titleBase
            : titleBase + " (Region " + currentView + ")";

        listContainer.innerHTML = sorted.map(function(sensor) {
            const value = sensor.data ? Object.values(sensor.data)[0] : "";
            const typeLabel = sensor.type.charAt(0).toUpperCase() + sensor.type.slice(1);
            const isAlert = sensor.status === "red";
            return (
                '<div class="sensor-list-item" data-sensor-id="' + sensor.id + '">' +
                    '<span>' + typeLabel + ' ' + sensor.displayId + '</span>' +
                    '<span style="color:' + (isAlert ? '#ef4444' : '#4b5563') + '; font-weight:' + (isAlert ? '700' : '500') + '">' +
                        (value || '') +
                    '</span>' +
                '</div>'
            );
        }).join("");

        listContainer.querySelectorAll(".sensor-list-item").forEach(function(item) {
            item.addEventListener("mouseenter", function() {
                highlightSensor(item.getAttribute("data-sensor-id"));
            });
            item.addEventListener("mouseleave", function() {
                clearHighlights();
            });
        });
    }

    function showTooltip(evt, sensor) {
        if (!tooltipFO || !tooltipDiv || !svgRoot || !sensor) return;
        let content = '<div style="font-weight:700; margin-bottom:4px;">' +
            sensor.type.charAt(0).toUpperCase() + sensor.type.slice(1) + ' Sensor #' + sensor.displayId +
            '</div>';
        Object.entries(sensor.data || {}).forEach(function(entry) {
            content += '<div><strong>' + entry[0] + ':</strong> ' + entry[1] + '</div>';
        });
        tooltipDiv.innerHTML = content;
        tooltipFO.style.visibility = "visible";

        const point = svgRoot.createSVGPoint();
        point.x = evt.clientX;
        point.y = evt.clientY;
        const ctm = svgRoot.getScreenCTM();
        if (!ctm) return;
        const cursor = point.matrixTransform(ctm.inverse());
        tooltipFO.setAttribute("x", cursor.x + 15);
        tooltipFO.setAttribute("y", cursor.y + 15);
    }

    function hideTooltip() {
        if (tooltipFO) {
            tooltipFO.style.visibility = "hidden";
        }
    }

    function attachMapListeners() {
        document.querySelectorAll(".sensor-group").forEach(function(group) {
            const sensorId = group.getAttribute("data-sensor-id");
            const sensor = sensorData.find(function(item) { return item.id === sensorId; });
            group.addEventListener("mouseenter", function(evt) {
                highlightSensor(sensorId);
                showTooltip(evt, sensor);
            });
            group.addEventListener("mouseleave", function() {
                hideTooltip();
                clearHighlights();
            });
            group.addEventListener("mousemove", function(evt) {
                showTooltip(evt, sensor);
            });
        });
    }

    function syncNavButtons(view) {
        if (panelNav) {
            panelNav.querySelectorAll(".nav-btn").forEach(function(btn) {
                const matches = btn.id === "nav-btn-" + (view === "full" ? "full" : view);
                btn.classList.toggle("active", matches);
            });
        }
        if (bottomNav) {
            bottomNav.querySelectorAll(".nav-btn").forEach(function(btn) {
                const matches = btn.getAttribute("data-view") === (view === "full" ? "full" : String(view));
                btn.classList.toggle("active", matches);
            });
        }
    }

    function setView(view) {
        currentView = view;
        setMapTransform(view);
        syncNavButtons(view);
        renderList();
    }

    function bindNav(container, extractor) {
        if (!container) return;
        container.querySelectorAll(".nav-btn").forEach(function(btn) {
            btn.addEventListener("click", function() {
                setView(extractor(btn));
            });
        });
    }

    function bindLegend(container) {
        if (!container) return;
        container.querySelectorAll(".legend-item").forEach(function(item) {
            item.addEventListener("click", function() {
                currentFilter = item.getAttribute("data-type");
                container.querySelectorAll(".legend-item").forEach(function(li) {
                    li.classList.toggle("active", li.getAttribute("data-type") === currentFilter);
                });
                renderList();
            });
        });
    }

    bindNav(panelNav, function(btn) { return btn.id === "nav-btn-full" ? "full" : btn.id.replace("nav-btn-", ""); });
    bindNav(bottomNav, function(btn) { return btn.getAttribute("data-view") || "full"; });
    bindLegend(legend);
    attachMapListeners();
    setView("full");
    window.setView = setView;
})();

                    // Attach tooltip listeners to sensor groups after first render
                    function setupSensorGroupTooltips() {
                        document.querySelectorAll('.sensor-group').forEach(group => {
                            const sensorId = group.dataset.sensorId;
                            const sensor = sensorData.find(s => s.id === sensorId);
                            if (!sensor) return;
                            group.addEventListener('mouseenter', (e) => {
                                highlightSensor(sensorId);
                                showTooltip(e, sensor);
                            });
                            group.addEventListener('mousemove', (e) => {
                                if (tooltip.classList.contains('visible')) {
                                    tooltip.style.left = `${e.clientX + 15}px`;
                                    tooltip.style.top = `${e.clientY + 15}px`;
                                }
                            });
                            group.addEventListener('mouseleave', () => {
                                hideTooltip();
                                unhighlightSensor();
                            });
                        });
                    }

                    // Initialize the application
                    init();
                </script>
            </body>
        </html>